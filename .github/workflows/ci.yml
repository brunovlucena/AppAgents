name: iOS CI/CD - Monorepo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.4'
  IOS_SIMULATOR: 'iPhone 15'
  IOS_VERSION: '17.5'

jobs:
  lint:
    name: Swift Lint
    runs-on: macos-14
    strategy:
      matrix:
        app: [AppRestaurant, AppMedical]
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Run SwiftLint for ${{ matrix.app }}
        run: |
          cd apps/${{ matrix.app }}
          if [ -f .swiftlint.yml ]; then
            swiftlint lint --strict
          fi

  test:
    name: Run Tests
    runs-on: macos-14
    strategy:
      matrix:
        app: [AppRestaurant, AppMedical]
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Build and Test ${{ matrix.app }}
        run: |
          cd apps/${{ matrix.app }}
          xcodebuild clean test \
            -project ${{ matrix.app }}.xcodeproj \
            -scheme ${{ matrix.app }} \
            -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}' \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Upload Coverage for ${{ matrix.app }}
        uses: codecov/codecov-action@v3
        with:
          flags: ios-${{ matrix.app }}
          name: ios-${{ matrix.app }}-coverage

  build:
    name: Build iOS Apps
    runs-on: macos-14
    needs: [lint, test]
    strategy:
      matrix:
        app: [AppRestaurant, AppMedical]
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Setup Fastlane
        run: |
          gem install fastlane
          bundle install
      
      - name: Build ${{ matrix.app }}
        run: |
          cd apps/${{ matrix.app }}
          if [ -f fastlane/Fastfile ]; then
            fastlane build
          else
            xcodebuild build \
              -project ${{ matrix.app }}.xcodeproj \
              -scheme ${{ matrix.app }} \
              -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }}'
          fi
        env:
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      
      - name: Upload Build Artifacts for ${{ matrix.app }}
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.app }}-build
          path: apps/${{ matrix.app }}/build/*.ipa
          retention-days: 7

  release:
    name: Release to TestFlight
    runs-on: macos-14
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      matrix:
        app: [AppRestaurant, AppMedical]
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Setup Fastlane
        run: |
          gem install fastlane
          bundle install
      
      - name: Release ${{ matrix.app }} to TestFlight
        run: |
          cd apps/${{ matrix.app }}
          fastlane beta
        env:
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
