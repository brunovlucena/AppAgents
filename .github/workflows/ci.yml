name: iOS CI/CD - Monorepo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.4'
  IOS_SIMULATOR: 'iPhone 15'
  IOS_VERSION: '17.5'

jobs:
  lint:
    name: Swift Lint
    runs-on: macos-14
    strategy:
      matrix:
        app: [AppRestaurant, AppMedical]
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Check if app exists
        id: check_app
        run: |
          if [ ! -d "apps/${{ matrix.app }}" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "App ${{ matrix.app }} not found, skipping"
            exit 0
          fi
          echo "exists=true" >> $GITHUB_OUTPUT
      
      - name: Run SwiftLint for ${{ matrix.app }}
        if: steps.check_app.outputs.exists == 'true'
        run: |
          cd apps/${{ matrix.app }}
          if [ -f .swiftlint.yml ]; then
            swiftlint lint --strict || echo "SwiftLint found issues or no config file"
          else
            echo "No .swiftlint.yml found, skipping lint"
          fi

  test:
    name: Run Tests
    runs-on: macos-14
    strategy:
      matrix:
        app: [AppRestaurant, AppMedical]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Show Xcode Version
        run: xcodebuild -version
      
      - name: Show Available Simulators
        run: xcrun simctl list devices available
      
      - name: Check if app and project exist
        id: check_app
        run: |
          APP_DIR="apps/${{ matrix.app }}"
          PROJECT_FILE="$APP_DIR/${{ matrix.app }}.xcodeproj"
          if [ ! -d "$APP_DIR" ] || [ ! -d "$PROJECT_FILE" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "App ${{ matrix.app }} or project not found, skipping"
            exit 0
          fi
          echo "exists=true" >> $GITHUB_OUTPUT
      
      - name: List project contents
        if: steps.check_app.outputs.exists == 'true'
        run: |
          cd apps/${{ matrix.app }}
          echo "=== Project Structure ==="
          find . -name "*.swift" | head -10 || echo "No Swift files found"
          ls -la || true
      
      - name: Build and Test ${{ matrix.app }}
        if: steps.check_app.outputs.exists == 'true'
        continue-on-error: true
        run: |
          cd apps/${{ matrix.app }}
          xcodebuild clean test \
            -project ${{ matrix.app }}.xcodeproj \
            -scheme ${{ matrix.app }} \
            -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}' \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -quiet || {
              echo "Build/test failed, checking for source files..."
              find . -name "*.swift" || echo "No Swift source files found"
              exit 1
            }
      
      - name: Upload Coverage for ${{ matrix.app }}
        if: steps.check_app.outputs.exists == 'true' && success()
        uses: codecov/codecov-action@v3
        with:
          flags: ios-${{ matrix.app }}
          name: ios-${{ matrix.app }}-coverage

  build:
    name: Build iOS Apps
    runs-on: macos-14
    needs: [lint, test]
    strategy:
      matrix:
        app: [AppRestaurant, AppMedical]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Check if app exists
        id: check_app
        run: |
          APP_DIR="apps/${{ matrix.app }}"
          PROJECT_FILE="$APP_DIR/${{ matrix.app }}.xcodeproj"
          if [ ! -d "$APP_DIR" ] || [ ! -d "$PROJECT_FILE" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "App ${{ matrix.app }} not found, skipping"
            exit 0
          fi
          echo "exists=true" >> $GITHUB_OUTPUT
      
      - name: Setup Fastlane
        if: steps.check_app.outputs.exists == 'true'
        run: |
          gem install fastlane
          if [ -f Gemfile ]; then bundle install; fi
      
      - name: Build ${{ matrix.app }}
        if: steps.check_app.outputs.exists == 'true'
        continue-on-error: true
        run: |
          cd apps/${{ matrix.app }}
          if [ -f fastlane/Fastfile ]; then
            fastlane build
          else
            xcodebuild build \
              -project ${{ matrix.app }}.xcodeproj \
              -scheme ${{ matrix.app }} \
              -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }}' \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO || {
                echo "Build failed for ${{ matrix.app }}"
                exit 1
              }
          fi
        env:
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      
      - name: Upload Build Artifacts for ${{ matrix.app }}
        if: steps.check_app.outputs.exists == 'true' && success()
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.app }}-build
          path: apps/${{ matrix.app }}/build/*.ipa
          retention-days: 7
          if-no-files-found: ignore

  release:
    name: Release to TestFlight
    runs-on: macos-14
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      matrix:
        app: [AppRestaurant, AppMedical]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Check if app exists
        id: check_app
        run: |
          APP_DIR="apps/${{ matrix.app }}"
          if [ ! -d "$APP_DIR" ] || [ ! -f "$APP_DIR/fastlane/Fastfile" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "App ${{ matrix.app }} or Fastfile not found, skipping"
            exit 0
          fi
          echo "exists=true" >> $GITHUB_OUTPUT
      
      - name: Setup Fastlane
        if: steps.check_app.outputs.exists == 'true'
        run: |
          gem install fastlane
          if [ -f Gemfile ]; then bundle install; fi
      
      - name: Release ${{ matrix.app }} to TestFlight
        if: steps.check_app.outputs.exists == 'true'
        run: |
          cd apps/${{ matrix.app }}
          fastlane beta
        env:
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
