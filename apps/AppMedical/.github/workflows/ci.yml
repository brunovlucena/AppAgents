name: iOS CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.4'
  IOS_SIMULATOR: 'iPhone 15'
  IOS_VERSION: '17.5'

jobs:
  lint:
    name: Swift Lint
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Run SwiftLint
        run: |
          cd AppMedical
          swiftlint lint --strict

  test:
    name: Run Tests
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Build and Test
        run: |
          cd AppMedical
          xcodebuild clean test \
            -project AppMedical.xcodeproj \
            -scheme AppMedical \
            -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}' \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          flags: ios
          name: ios-coverage

  build:
    name: Build iOS App
    runs-on: macos-14
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Setup Fastlane
        run: |
          gem install fastlane
          bundle install
      
      - name: Build with Fastlane
        run: |
          cd AppMedical
          fastlane build
        env:
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}

  release:
    name: Release to TestFlight
    runs-on: macos-14
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
      - name: Setup Fastlane
        run: |
          gem install fastlane
          bundle install
      
      - name: Release to TestFlight
        run: |
          cd AppMedical
          fastlane beta
        env:
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
